<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="Style.css">
</head>
<body>
    <input id = "id" type="hidden">
    <label for = "name"> Name : </label>
    <input id = "name">
    <br>
    <label for="description"> Description : </label>
    <input id="description">
    <br>
    <label for="myProject"> Project: </label>
    <input id="myProject" type="file">
    <br>
    <button onclick="AddOrEdit()">AddOrEdit</button>
    <hr>
    <div id="main"></div>
    <script>
        async function getData() {
            try{
                let respone = await fetch('/projects');
                let data = await respone.json();
                createGrid(data);
                console.log(data);
            }
            catch(err){
                alert(err);
            }
        }

        function createGrid(data){
            let txt = "";
            for(obj of data){
                if(obj){
                    let prjSrc = obj.filename ? `/Uploads/${obj.filename}` : 'defualt-image.png';
                    txt+= `<div class  = "ProjCard">
                        <div>
                            <img src = "/Uploads/${obj.filename}"alt = "${obj.name}">
                            <p>${obj.name}</p>
                                <div>${obj.description}</div>
                                </div>
                                <div>
                                    <div>Average Rating: ${obj.average} ‚≠ê</div>
                                <button onclick="DeleteProject(${obj.id})">Delete</button>
                                <button onclick="gettingByid(${obj.id})">Edit</button>
                                <button onclick="showProject(${obj.id})">Show Project</button>
                                </div>
                                </div>`
                }
            }
            document.getElementById('main').innerHTML = txt;
        }
        async function addProject() {
            try{
                let name = document.getElementById('name').value;
                let description = document.getElementById('description').value;
                let myProject = document.getElementById('myProject');
                let preview = myProject.files.length > 0 ? myProject.files[0]: null;

                let formData = new FormData();
                formData.append('name',name);
                formData.append('description',description);
                if(preview){
                    formData.append('myProject',preview);
                }
               let response = await fetch('/projects',{
                    method: 'POST',
                    body: formData
                });
                if(!response.ok){
                    alert("Error: "+"You need to write Name and Description and upload Project !!");
                    alert("Error : "+err.message);
                    return;
                }
                let data = await response.json();
                alert("Project added successfully!");
                getData();
                clearInputs();
            }
            catch(err){
                alert(err);
            }
        }
        function clearInputs(){
            document.getElementById('name').value="";
            document.getElementById('description').value="";
            document.getElementById('myProject').value="";
        }
        async function DeleteProject(id) {
            try{
                if(confirm('are you sure you want to delete is ?')){
                    await fetch(`/projects/${id}`,{
                        method : 'DELETE'
                    })
                }
                getData();
            }catch(err){
                alert(err);
            }
        }
        async function gettingByid(id) {
            try{
                let respone = await fetch(`/projects/${id}`);
                let obj = await respone.json();
                document.getElementById('id').value=obj.id;
                document.getElementById('name').value=obj.name;
             document.getElementById('description').value=obj.description;
            }
            catch(err){
                alert(err);
            }
            
        }
        async function Edit(id) {
            try{
                let name = document.getElementById('name').value;
                let description = document.getElementById('description').value;
                let myProject = document.getElementById('myProject').files[0];
                let formData = new FormData();
                formData.append('name',name);
                formData.append('description',description);
                if(myProject){
                    formData.append('myProject',myProject);
                }
                await fetch(`/projects/${id}`,{
                    method: 'PATCH',
                    body: formData
                })
                getData();
                clearInputs();
            }catch(err){
                alert(err);
            }
        }

        function AddOrEdit(){
            let id = document.getElementById('id').value;
            if(id){
                Edit(id);
            }
            else{
                addProject();
            }
        }
         function showProject(id){
         window.open(`ShowProject.html?id=${id}`, '_blank');
        }

        getData();
    </script>
</body>
</html>